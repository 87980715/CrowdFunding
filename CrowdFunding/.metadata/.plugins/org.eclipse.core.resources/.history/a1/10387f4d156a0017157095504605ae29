<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<html>
<head>
<title>众筹系统</title>
<link rel="stylesheet" href="static/bootstrap/bootstrap.min.css">
<link rel="stylesheet" href="static/pagination/pagination.css">
<link rel="stylesheet" href="static/loading/global.css">
<link rel="stylesheet" href="static/loading/loading.css">
<script type="text/javascript" src="static/jquery/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="static/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="static/pagination/pagination.js"></script>
<script type="text/javascript" src="static/loading/loading.js"></script>
</head>

<style>
body {
	text-align: center;
}

.table th, .table td {
	text-align: center;
	vertical-align: middle;
}
</style>

<script>
function loading() {
	$("#loading").loading({
		loadingWidth:240,
		title:'请稍等!',
		name:'loading',
		discription:'马上就好',
		direction:'column',
		type:'origin',
		// originBg:'#71EA71',
		originDivWidth:40,
		originDivHeight:40,
		originWidth:6,
		originHeight:6,
		smallLoading:false,
		loadingMaskBg:'rgba(0,0,0,0.2)'
	});

	setTimeout(function(){
		removeLoading('loading');
	},3000);
}

	$(function() {
		get(1); // 首次加载 
		
		function PageCallback(index, jq) {
			$("#table").empty();
			
			get(index);
		}
		
		function get(index) {
			$.ajax({
			    type: "POST",
			    dataType: "json",
			    url: 'getFunds',
			    data: {"pageIndex" : index},
			    beforeSend:function () {
			    	// $("#fakeLoader").fakeLoader();
			    },
			    success: function(page) {
			    	// 后台返回结果为空
			    	if($.isEmptyObject(page))
			    		{
			    		$("#table").append('<p class="text-danger">暂无众筹</p>');
			    		}
			    	// 后台返回结果非空
			    	else {
			    		
			    		var totalNum = page.totalNum;
			    		var totalPage = page.totalPage;
			    		var pageIndex = page.nowIndex;
			    		var data = page.dataList; // 当前页记录
			    		
			    		var tab = "";
			    		tab += '<thead><tr>';
			    		tab += '<th>众筹地址</th>';
			    		tab += '<th>已筹人数</th>';
			    		tab += '<th>已筹金币</th>';
			    		tab += '<th>操作</th>';
						tab += '<tr></thead>';
		    			
						tab += '<tbody>';
			    		$.each(data, function (i, fund) {
			    			tab += '<tr>';
			    			tab += '<td>' + fund['owner'] + '</td>';
			    			tab += '<td>' + fund['number'] + '</td>';
			    			tab += '<td>' + fund['coin'] + '</td>';
							tab += '<td>' + '<button type="button" class="btn btn-primary btn-sm"' + 
							'data-toggle="modal" data-target="#myModal"' + 
							'onclick="select(' + "'" + fund['owner'] + "'" + ')">我要捐赠</button>' + '</td>';
		    				tab += '</tr>';
		    			});
			    		tab += '</tbody>';
			    		$("#table").append(tab);
			    		
			    		if($("#Pagination").html() == "") {
							$("#Pagination").pagination(totalNum, {            
						        callback: PageCallback,            
						        prev_text: '上一页',             
						        next_text: '下一页',  
						        ellipse_text: '...',
						        // current_page: pageIndex,
						        items_per_page: 5,              
						        num_display_entries: 4, // 连续分页主体部分显示的分页条目数    
						        num_edge_entries: 1 // 两侧显示的首尾分页的条目数
						    });
						}
			    	}
			    },
			    	complete:function(){
			        	// 隐藏loading
			    	}
			    });
		}
	
	}); // $.

	function select(owner) {
		$('#owner').val(owner);
	}

	// 模态框1
	function confirm() {
		var owner = $.trim($('#owner').val());
		var coin = $.trim($('#coin').val());
		var password = $.trim($('#password').val());
		var file = $.trim($('#file').val());
		if (!owner || !coin || !password || !file) {
			alert('信息不完善！');
			return false;
		}

		// 读取文件
		var reader = new FileReader();
		reader.readAsText(document.getElementById("file").files[0], "UTF-8");
		reader.onload = function(e) {
			var content = e.target.result;

			// 异步提交
			$.ajax({
				url : "sendCoin",
				type : "POST",
				data : {
					"owner" : owner,
					"coin" : coin,
					"password" : password,
					"content" : content
				},
				beforeSend : function() {
					$("#tip").html('<span style="color:blue">正在处理...</span>');
					return true;
				},
				success : function(res) {
					if (res) {
						alert('操作成功');
					} else {
						alert('操作失败');
					}
					setTimeout(function() {
						$("#myModal").modal('hide')
					}, 1000);
				}
			});
		};
		return false;
	}

	//模态框2
	function confirm2() {
		var password = $.trim($('#password2').val());
		var file = $.trim($('#file2').val());
		if (!password || !file) {
			alert('信息不完善！');
			return false;
		}

		// 读取文件
		var reader = new FileReader();
		reader.readAsText(document.getElementById("file2").files[0], "UTF-8");
		reader.onload = function(e) {
			var content = e.target.result;

			// 异步提交
			$.ajax({
				url : "raiseFund",
				type : "POST",
				data : {
					"password" : password,
					"content" : content
				},
				beforeSend : function() {
					$("#tip2").html('<span style="color:blue">正在处理...</span>');
					return true;
				},
				success : function(res) {
					if (res) {
						alert('操作成功');
					} else {
						alert('操作失败');
					}
					setTimeout(function() {
						$("#myModal2").modal('hide')
					}, 1000);
				}
			});
		};
		return false;
	}

	// 模态框1
	$(function() {
		$('#myModal').on('hide.bs.modal', function() {
			$("#owner").val('');
			$("#coin").val('');
			$("#password").val('');
			$("#file").val('');
			$("#tip").html('<span id="tip"> </span>');
		})
	});

	//模态框2
	$(function() {
		$('#myModal2').on('hide.bs.modal', function() {
			$("#password2").val('');
			$("#file2").val('');
			$("#tip2").html('<span id="tip2"> </span>');
		})
	});
</script>

<body>
	<div class="container">
		<div class="jumbotron">

			<h2 class="text-muted">众筹列表</h2>
			
			<table id="table" class="table"></table>
			<div id="loading"></div>
			<div id="Pagination"></div>

			<button type="button" class="btn btn-success btn-lg"
				data-toggle="modal" data-target="#myModal2">我要众筹</button>
		</div>
	</div>

	<!-- 模态框1（Modal） -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">×</button>
					<h4 class="modal-title" id="myModalLabel">发送金币</h4>
				</div>

				<div class="modal-body">
					<form class="form-horizontal" role="form">
						<div class="form-group">
							<label class="col-sm-2 control-label">地址</label>
							<div class="col-sm-8">
								<input type="text" class="form-control" id="owner" name="owner"
									placeholder="0x..." readOnly />
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-2 control-label">金币</label>
							<div class="col-sm-8">
								<input type="text" class="form-control" id="coin" name="coin" />
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-2 control-label">密码</label>
							<div class="col-sm-8">
								<input type="text" class="form-control" id="password"
									name="password" />
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-2 control-label">密钥</label>
							<div class="col-sm-8">
								<input type="file" id="file" name="file" />
							</div>
						</div>
					</form>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" onclick="confirm()">确认</button>
					<span id="tip"> </span>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
	<!-- /.modal -->

	<!-- 模态框2（Modal） -->
	<div class="modal fade" id="myModal2" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel2" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">×</button>
					<h4 class="modal-title" id="myModalLabel2">发起众筹</h4>
				</div>

				<div class="modal-body">
					<form class="form-horizontal" role="form">
						<div class="form-group">
							<label class="col-sm-2 control-label">密码</label>
							<div class="col-sm-8">
								<input type="text" class="form-control" id="password2"
									name="password2" />
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-2 control-label">密钥</label>
							<div class="col-sm-8">
								<input type="file" id="file2" name="file2" />
							</div>
						</div>
					</form>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" onclick="confirm2()">确认</button>
					<span id="tip2"> </span>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
	<!-- /.modal -->
</body>
</html>