package com.redhat.crowdfunding.util;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;

import org.web3j.crypto.CipherException;
import org.web3j.crypto.Credentials;
import org.web3j.crypto.WalletUtils;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.http.HttpService;

import com.redhat.crowdfunding.contract.CrowdFundingContract;
import com.redhat.crowdfunding.contract.CrowdFundingInterface;

/**
 * @author littleredhat
 */
public class Util {

	/**
	 * 加载钱包文件
	 * 
	 * @return
	 * @throws Exception
	 */
	private static String readWallet() {
		try {
			// 读取文件
			InputStream is = Util.class.getResourceAsStream(Consts.PATH);
			InputStreamReader isreader;
			isreader = new InputStreamReader(is, "UTF-8");
			BufferedReader bReader = new BufferedReader(isreader);
			StringBuilder sb = new StringBuilder();
			String lineTxt = null;
			while ((lineTxt = bReader.readLine()) != null)
				sb.append(lineTxt);
			bReader.close();
			isreader.close();
			is.close();
			return sb.toString();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}

	/**
	 * 获取管理员凭证
	 * 
	 * @param contractAddress
	 *            合约地址
	 * @return
	 * @throws Exception
	 */
	public static Credentials GetCredentials() {
		// 管理员凭证
		return GetCredentials(Consts.PASSWORD, readWallet());
	}

	/**
	 * 获取发送者凭证
	 * 
	 * @param password
	 *            密钥密码
	 * @param content
	 *            密钥内容
	 * @param contractAddress
	 *            合约地址
	 * @return
	 * @throws Exception
	 */
	public static Credentials GetCredentials(String password, String content) {
		// 临时文件
		File tmp = null;
		try {
			tmp = File.createTempFile(Consts.PREFIX, Consts.SUFFIX);
			// 自动删除
			tmp.deleteOnExit();
			// 写入内容
			BufferedWriter out = new BufferedWriter(new FileWriter(tmp));
			out.write(content);
			out.close();
		} catch (IOException e) {
			e.printStackTrace();
		}

		// 发送者凭证
		Credentials credentials = null;
		try {
			credentials = WalletUtils.loadCredentials(password, tmp);
		} catch (IOException | CipherException e) {
			e.printStackTrace();
		}
		return credentials;
	}

	/**
	 * 众筹合约
	 * 
	 * @param credentials
	 * @param contractAddress
	 * @return
	 */
	public static CrowdFundingInterface GetRegisterContract(Credentials credentials, String contractAddress) {
		// defaults to http://localhost:8545/
		Web3j web3j = Web3j.build(new HttpService());
		// 获取合约
		CrowdFundingInterface contract = new CrowdFundingContract(contractAddress, web3j, credentials, Consts.GAS_PRICE,
				Consts.GAS_LIMIT);
		return contract;
	}
}
