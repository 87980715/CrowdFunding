$(function() {
	// 首次加载
	get(1);

	function pageCallback(index, jq) {
		// 清空表格
		$("#table").empty();
		get(index);
	}

	function get(index) {
		$
				.ajax({
					type : "POST",
					dataType : "json",
					url : 'getFunds',
					data : {
						"pageIndex" : index
					},
					beforeSend : function() {
						// 显示loading
						loading();
					}, // beforeSend
					success : function(page) {
						// 后台返回结果为空
						if ($.isEmptyObject(page)) {
							$("#table").append(
									'<p class="text-danger">暂无众筹</p>');
						}
						// 后台返回结果非空
						else {
							var totalNum = page.totalNum;
							var totalPage = page.totalPage;
							var data = page.dataList; // 当前页记录
							var tab = "";

							// thead
							tab += '<thead><tr>';
							tab += '<th>众筹地址</th>';
							tab += '<th>已筹人数</th>';
							tab += '<th>已筹金币</th>';
							tab += '<th>操作</th>';
							tab += '<tr></thead>';
							// tbody
							tab += '<tbody>';
							$
									.each(
											data,
											function(i, fund) {
												tab += '<tr>';
												tab += '<td>' + fund['owner']
														+ '</td>';
												tab += '<td>' + fund['number']
														+ '</td>';
												tab += '<td>' + fund['coin']
														+ '</td>';
												tab += '<td>'
														+ '<button type="button" class="btn btn-primary btn-sm"'
														+ 'data-toggle="modal" data-target="#myModal"'
														+ 'onclick="select('
														+ "'" + fund['owner']
														+ "'"
														+ ')">我要捐赠</button>'
														+ '</td>';
												tab += '</tr>';
											});
							tab += '</tbody>';

							$("#table").append(tab);

							if ($("#pagination").html() == "") {
								$("#pagination").pagination(totalNum, {
									callback : pageCallback,
									prev_text : '<<<',
									next_text : '>>>',
									ellipse_text : '...',
									current_page : index, // 当前选中的页面
									items_per_page : 5, // 每页显示的条目数
									num_display_entries : 4, // 连续分页主体部分显示的分页条目数
									num_edge_entries : 1
								// 两侧显示的首尾分页的条目数
								});
							}
						}
					}, // success
					complete : function() {
						// 隐藏loading
						removeLoading('loading');
					} // complete
				});
	}

});

function loading() {
	$("#loading").loading({
		loadingWidth : 240,
		title : '加载中...',
		name : 'loading',
		discription : '马上就好',
		direction : 'column',
		type : 'origin',
		originDivWidth : 40,
		originDivHeight : 40,
		originWidth : 6,
		originHeight : 6,
		smallLoading : false,
		loadingMaskBg : 'rgba(0,0,0,0.2)'
	});
}

function select(owner) {
	$('#owner').val(owner);
}

// 模态框1
function confirm() {
	var owner = $.trim($('#owner').val());
	var coin = $.trim($('#coin').val());
	var password = $.trim($('#password').val());
	var file = $.trim($('#file').val());
	if (!owner || !coin || !password || !file) {
		alert('信息不完善！');
		return false;
	}

	// 读取文件
	var reader = new FileReader();
	reader.readAsText(document.getElementById("file").files[0], "UTF-8");
	reader.onload = function(e) {
		var content = e.target.result;

		// 异步提交
		$.ajax({
			url : "sendCoin",
			type : "POST",
			data : {
				"owner" : owner,
				"coin" : coin,
				"password" : password,
				"content" : content
			},
			beforeSend : function() {
				$("#tip").html('<span style="color:blue">正在处理...</span>');
				return true;
			},
			success : function(res) {
				if (res) {
					alert('操作成功');
				} else {
					alert('操作失败');
				}
				setTimeout(function() {
					$("#myModal").modal('hide')
				}, 1000);
			}
		});
	};
	return false;
}

// 模态框2
function confirm2() {
	var password = $.trim($('#password2').val());
	var file = $.trim($('#file2').val());
	if (!password || !file) {
		alert('信息不完善！');
		return false;
	}

	// 读取文件
	var reader = new FileReader();
	reader.readAsText(document.getElementById("file2").files[0], "UTF-8");
	reader.onload = function(e) {
		var content = e.target.result;

		// 异步提交
		$.ajax({
			url : "raiseFund",
			type : "POST",
			data : {
				"password" : password,
				"content" : content
			},
			beforeSend : function() {
				$("#tip2").html('<span style="color:blue">正在处理...</span>');
				return true;
			},
			success : function(res) {
				if (res) {
					alert('操作成功');
				} else {
					alert('操作失败');
				}
				setTimeout(function() {
					$("#myModal2").modal('hide')
				}, 1000);
			}
		});
	};
	return false;
}

// 模态框1
$(function() {
	$('#myModal').on('hide.bs.modal', function() {
		$("#owner").val('');
		$("#coin").val('');
		$("#password").val('');
		$("#file").val('');
		$("#tip").html('<span id="tip"> </span>');
	})
});

// 模态框2
$(function() {
	$('#myModal2').on('hide.bs.modal', function() {
		$("#password2").val('');
		$("#file2").val('');
		$("#tip2").html('<span id="tip2"> </span>');
	})
});